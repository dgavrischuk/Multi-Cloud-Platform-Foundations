name: 'Deployment Tests'

on:
  push:
    branches:
      - main
      - develop

jobs:
  ############################# Deployment Tests for GCP modules #####################################################
  MCP-tests:
    runs-on: ubuntu-latest

    env:
      working-directory: ./tests/gcp/deployment
      #GCP_PROJECT_ID: "mcpdeploytest-${GITHUB_SHA::8}-$(date +%H%M%S)"
      

    defaults:
      run:
        shell: bash
        working-directory: ${{env.working-directory}}

    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout
        uses: actions/checkout@v2

      # Install the latest version of Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_wrapper: false

      # Install gcloud sdk and set the service account
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v0
        with:
          service_account_key: ${{secrets.GCP_SA_KEY}}
          export_default_credentials: true

      # - name: Set constant variables
      #   id: vars
      #   run: echo "::set-output name=GCP_PROJECT_ID::${{ env.GCP_PROJECT_ID }}"

      
      - name: Deploy GCP modules
        run: |
          cd google_folder
          terraform init
          terraform plan -out="./plan.tfplan"
          terraform apply plan.tfplan
          terraform plan -destroy -out="./destroy.tfplan"
          terraform apply destroy.tfplan

     